<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>EMIS Survey Application</title>
  <!-- Google Font for a modern look -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700" rel="stylesheet">
  <!-- MSAL and docx libraries for SharePoint upload and Word report generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/msal/1.4.4/msal.min.js"></script>
  <script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@7.6.0/build/index.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    /* Global Styles */
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f9fc;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
    }
    h1, h2, h3, h4 {
      margin-bottom: 15px;
      color: #007BFF;
    }
    p {
      margin: 15px 0;
      line-height: 1.6;
    }
    /* Card/Page Styling */
    .page {
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      margin-bottom: 30px;
    }
    .hidden {
      display: none;
    }
    /* Section Styling */
    .section {
      margin-bottom: 20px;
      padding: 15px;
      background: #f1f5f9;
      border-left: 4px solid #007BFF;
      border-radius: 4px;
    }
    .section label.include {
      font-weight: 500;
      display: block;
      margin-bottom: 8px;
    }
    /* Inner content wrapper for internal inputs/text */
    .inner-content {
      margin-top: 10px;
      padding-left: 10px;
      border-left: 2px solid #ccc;
    }
    .inline-input {
      margin: 5px 0;
      padding: 6px;
      width: auto;
      font-size: 14px;
    }
    textarea {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
    }
    /* Button Styling */
    button {
      background: #007BFF;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
    }
    button:hover {
      background: #0056b3;
    }
    /* Main Tabs Styling */
    .tabs {
      display: flex;
      flex-wrap: wrap;
      border-bottom: 2px solid #eee;
      margin-bottom: 20px;
    }
    .tabs button {
      background: none;
      border: none;
      padding: 10px 15px;
      margin-right: 5px;
      cursor: pointer;
      font-weight: 500;
      font-size: 16px;
      color: blue;
    }
    .tabs button.active {
      border-bottom: 3px solid #007BFF;
      color: #007BFF;
    }
    /* Report Styling */
    .report-output {
      background: #ffffff;
      border: 1px solid #007BFF;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-family: 'Roboto', sans-serif;
      color: #333;
      line-height: 1.6;
    }
    .report-output p {
      margin-bottom: 15px;
    }
    .report-output ul {
      margin: 15px 0 15px 40px;
    }
    .report-output li {
      margin-bottom: 10px;
    }
    .report-buttons {
      text-align: center;
      margin-top: 20px;
    }
    .page2-buttons {
      text-align: center;
      margin-top: 20px;
    }
    /* Improved User Info Page Styles */
.org-info-page {
  background: #ffffff;
  border: 1px solid #ddd;
  padding: 40px 30px;
  border-radius: 10px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  max-width: 500px;
  margin: 50px auto;
}
.org-info-page h1 {
  text-align: center;
  font-size: 28px;
  margin-bottom: 30px;
  color: #007BFF;
}
.org-info-page label {
  font-size: 16px;
  margin-bottom: 5px;
  display: block;
  color: #333;
}
.org-info-page input[type="text"],
.org-info-page select,
.org-info-page textarea {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  border: 1px solid #ccc;
  border-radius: 4px;
  margin-bottom: 20px;
  transition: border-color 0.3s ease;
}
.org-info-page input[type="text"]:focus,
.org-info-page select:focus,
.org-info-page textarea:focus {
  border-color: #007BFF;
  outline: none;
}
.org-info-page .actions {
  text-align: center;
  margin-top: 20px;
}
.org-info-page button {
  background: #007BFF;
  border: none;
  color: #fff;
  padding: 12px 25px;
  font-size: 16px;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.3s ease;
  margin-bottom: 30px;
  margin-left: 10px;
}
.org-info-page button:hover {
  background: #0056b3;
}
  </style>
</head>
<body>
  <div class="container">
    <!-- NEW: User Information Page -->
    <div id="org-page" class="org-info-page">
      <h1>Organization Information</h1>
      <form id="user-info-form">
        <div class="form-group">
          <label for="application-name">Application ID:</label>
          <input type="text" id="application-name" required>
        </div>
        <div class="form-group">
          <label for="organization-name">Organization Name:</label>
          <input type="text" id="organization-name" required>
        </div>
        <div class="form-group">
          <label for="organization-type">Facility Type:</label>
          <select id="organization-type">
            <option value="11 - Agriculture, forestry, fishing and hunting">11 - Agriculture, forestry, fishing and hunting</option>
            <option value="21 - Mining, quarrying, and oil and gas extraction">21 - Mining, quarrying, and oil and gas extraction</option>
            <option value="22 - Utilities">22 - Utilities</option>
            <option value="23 - Construction">23 - Construction</option>
            <option value="31-32-33 - Manufacturing">31-32-33 - Manufacturing</option>
            <option value="48 - Transportation">48 - Transportation</option>
            <option value="56 - Administrative and support, waste management and remediation services">56 - Administrative and support, waste management and remediation services</option>
          </select>
        </div>
        <div class="form-group">
          <label for="site-address">Facility Address:</label>
          <input type="text" id="site-address" required>
        </div>
        <div class="form-group">
          <label for="attendee-names">Attendee Name:</label>
          <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px">
            <input type="text" id="attendee-names" placeholder="Enter attendee name">
            <button type="button" id="add-attendee-btn">Add</button>
          </div>
          <ul id="attendee-list"></ul>
        </div>
        <div class="actions">
          <button type="button" id="start-assessment">Start Assessment</button>
        </div>
      </form>
    </div>

    <!-- Existing Survey Pages -->
    <!-- Technical Objectives Page -->
    <div id="page1" class="page hidden">
      <h1>Technical Objectives Survey</h1>
      <form id="techObjectivesForm">
        <div class="section">
          <label>
            <input type="checkbox" id="obj1">
            Facilitate continuous energy management and increased operational efficiency
          </label>
        </div>
        <div class="section">
          <label>
            <input type="checkbox" id="obj2" onchange="togglePercentage()">
            Enable the organization to reduce portfolio energy use by - 
          </label>
          <input type="text" id="reductionPercentage" placeholder="Enter percentage" class="inline-input hidden">
          <span> percent</span>
        </div>
        <div class="section">
          <label>
            <input type="checkbox" id="obj3">
            Automate energy performance analysis using an energy information system
          </label>
        </div>
        <div class="section">
          <label>
            <input type="checkbox" id="obj4">
            Perform automated fault detection and diagnostics (FDD) for the HVAC system
          </label>
        </div>
        <div class="section">
          <label>
            <input type="checkbox" id="obj5">
            Achieve automated system optimization with the EMIS software performing supervisory control to supplement the building automation system (BAS)
          </label>
        </div>
        <div class="section">
          <label>
            <input type="checkbox" id="obj6">
            Track the impact of energy efficiency projects, and measure and verify savings
          </label>
        </div>
        <div class="section">
          <label>
            <input type="checkbox" id="obj7">
            Track and manage peak demand
          </label>
        </div>
        <div class="section">
          <label>
            <input type="checkbox" id="obj8">
            Produce reports for energy and utility management, operations, and maintenance
          </label>
        </div>
        <div class="section">
          <label>
            <input type="checkbox" id="obj9">
            Support implementation of ISO 50001 Ready
          </label>
        </div>
        <div class="section">
          <label>
            <input type="checkbox" id="obj10">
            Manage GHG emission monitoring and subsequent reporting
          </label>
        </div>
        <button type="button" onclick="showPage('page2')">Next</button>
      </form>
    </div>

    <!-- EMIS Specifications Page -->
    <div id="page2" class="page hidden">
      <h1>EMIS Specifications Survey</h1>
      <div class="tabs">
        <button type="button" class="active" onclick="openTab('tab1', event)">Data Integration</button>
        <button type="button" onclick="openTab('tab2', event)">Utility Bill Analytics</button>
        <button type="button" onclick="openTab('tab3', event)">Interval Meter Data Analytics</button>
        <button type="button" onclick="openTab('tab4', event)">System Data Analytics</button>
        <button type="button" onclick="openTab('tab5', event)">Automated System Optimization</button>
        <button type="button" onclick="openTab('tab6', event)">Project Management and Reporting</button>
        <button type="button" onclick="openTab('tab7', event)">IT Requirements</button>
        <button type="button" onclick="openTab('tab8', event)">Technical Warranty, Support and Training</button>
      </div>

      <!-- Tab 1: Data Integration -->
      <div id="tab1" class="tab-content">
        <!-- 1.1 Utility data integration -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_1_1" onchange="toggleInnerContent(this)">
            1.1 Utility data integration
          </label>
          <div class="inner-content hidden">
            <p>The technology will provide the capability to integrate utility meter data from existing systems:</p>
            <div>
              <label><input type="checkbox" id="utility_electricity_tab1"> Electricity</label><br>
              <label><input type="checkbox" id="utility_naturalGas_tab1"> Natural Gas</label><br>
              <label><input type="checkbox" id="utility_propane_tab1"> Propane</label><br>
              <label><input type="checkbox" id="utility_steam_tab1"> Steam</label><br>
              <label><input type="checkbox" id="utility_chilledWater_tab1"> Chilled Water</label><br>
              <label><input type="checkbox" id="utility_water_tab1"> Water</label><br>
              <label><input type="checkbox" id="utility_wasteWater_tab1"> Waste Water</label><br>
              <label><input type="checkbox" id="utility_compressedAir_tab1"> Compressed Air</label><br>
              <label><input type="checkbox" id="utility_renewableEnergy_tab1"> Renewable Energy</label>
            </div>
          </div>
        </div>
        <!-- 1.2 Interval sub-meter data integration -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_1_2" onchange="toggleInnerContent(this)">
            1.2 Interval sub-meter data integration
          </label>
          <div class="inner-content hidden">
            <p>The technology will integrate with new and existing meters and monitoring systems from an interval meter and/or meters with pulse outputs. Where it is necessary to take advantage of existing metering data, the technology will integrate with the following systems for whole facility meters and/or submeters:</p>
            <div>
              <label>SPECIFY THE SUBMETERS:</label>
              <input type="text" id="submeters_1_2" class="inline-input" placeholder="Enter submeter details">
              <button type="button" onclick="addSubmeter()">Add</button>
              <ul id="submetersList"></ul>
            </div>
            <p>The desired data collection interval will be OPTIONS [hourly or sub-hourly (e.g., 15-minute data)].</p>
            <div>
              <label><input type="radio" name="interval_1_2" value="Hourly" checked onchange="toggleMinutesInput()"> Hourly</label><br>
              <label><input type="radio" name="interval_1_2" value="Sub-hourly" onchange="toggleMinutesInput()"> Sub-hourly</label>
              <span id="minutesInputSpan" class="hidden">
                Specify minutes: <input type="text" id="subhourlyMinutes" class="inline-input" placeholder="e.g., 5">
              </span>
            </div>
            <p>Data should be available for analysis in real or near-real time through a continuous and automated data acquisition process.</p>
            <p>The technology will have the capability to consolidate meter readings to create virtual meter points. In other words, it can add and subtract the readings from multiple meters at the same interval, to produce a calculated time series of energy use.</p>
            <p>The technology will be able to upload and store a minimum history of 5 years of energy use or other data from standard spreadsheet or text file formats.</p>
            <p>The technology will have the capacity to store at least 5 years of data, trended at intervals up to 15 minutes for analysis, reporting, and visualization.</p>
            <p>The technology will have the ability to parse out data cluster displays into coincident time intervals ranging from 10 minutes to 1 year.</p>
          </div>
        </div>
        <!-- 1.3 Building automation system (BAS) data integration -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_1_3" onchange="toggleInnerContent(this)">
            1.3 Building automation system (BAS) data integration
          </label>
          <div class="inner-content hidden">
            <p>The technology will extract data from the building control systems for Fault Detection and Diagnostics (FDD) functions:</p>
            <p>The data collection interval will be selected to meet the needs of the FDD software and is compatible with BAS trending, with 15-minute interval data being the most implemented. Change of value and/or slower polling rates may be needed to reduce network burden on the control system, and the effect of data collection interval on network speed will be determined during FDD setup. Slower or faster polling rates may also be implemented based on the type of fault (e.g., hunting and cycling faults may need one- to five-minute interval data).</p>
            <p>Integration with non-legacy vintages of BAS providers will occur via common protocols such as BACnet and Modbus, or through the BAS vendor’s gateway. If the BAS does not support BACnet, a data gateway or protocol converter will need to be installed by the EMIS vendor.</p>
            <p>BAS data will be integrated as follows:</p>
            <p>    These data include:</p>
            <ul>
              <li><input type="checkbox" id="bas_chillerBoiler_1_3"> chiller/boiler plant data</li>
              <li><input type="checkbox" id="bas_airHandler_1_3"> air handler data</li>
              <li><input type="checkbox" id="bas_zoneDevice_1_3"> zone device data</li>
            </ul>
            <p>    Integration will include but not be limited to:</p>
            <ul>
              <li><input type="checkbox" id="bas_energyMeter_1_3"> energy meter data already connected into the BAS</li>
              <li><input type="checkbox" id="bas_equipmentStatus_1_3"> equipment status</li>
              <li><input type="checkbox" id="bas_setpoints_1_3"> setpoints</li>
              <li><input type="checkbox" id="bas_valveSignals_1_3"> valve/damper control signals</li>
              <li><input type="checkbox" id="bas_fanSpeed_1_3"> fan speed</li>
              <li><input type="checkbox" id="bas_airFlow_1_3"> air flow rate</li>
              <li><input type="checkbox" id="bas_pumpFlow_1_3"> pump water flow rate</li>
              <li><input type="checkbox" id="bas_temperatures_1_3"> air and water temperatures</li>
            </ul>
            <p>Near-real time data polling or end of day batch uploads to the EMIS are acceptable.</p>
            <p>The data integration will not adversely affect the speed of the existing BAS control or visualization functions.</p>
          </div>
        </div>
        <!-- 1.4 Additional monitoring required or preferred -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_1_4" onchange="toggleInnerContent(this)">
            1.4 Additional monitoring required or preferred
          </label>
          <div class="inner-content hidden">
            <textarea id="additionalMonitoring" style="height:160px;">
Additional metering and monitoring may include the following:

· Major energy end uses (panel level): Switchgear panel, etc.
· Equipment level energy end uses: chiller, boiler, cooling towers, pumps, compressors, air handlers, major electromotors, etc. 
· Functional area/zones of building/plant energy end uses: chiller plant, compressed air system, etc.
· Additional building automation system or process control points
            </textarea>
          </div>
        </div>
        <!-- 1.5 Metadata / data tagging -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_1_5" onchange="toggleInnerContent(this)">
            1.5 Metadata / data tagging
          </label>
          <div class="inner-content hidden">
            <p>The use of standard naming conventions and a metadata schema (which may be referred to as ‘data tags’) improves the ability of the EMIS to consistently analyze, visualize, and derive value from operational data. A metadata schema will be selected for the EMIS project, defining at a minimum:</p>
            <ul>
              <li>a data dictionary for all terms used in the schema;</li>
              <li>a data taxonomy, providing categories and subcategories for the defined terms;</li>
            </ul>
            <p>The specific version of the metadata schema should be noted, as well as noting whether the schema is an adaptation or extension of another existing schema.</p>
            <p>The EMIS vendor will provide appropriate metadata for all data integrated with the EMIS, in alignment with the schema or tagging system selected for the project.</p>
          </div>
        </div>
        <!-- 1.6 Other data sources and APIs -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_1_6" onchange="toggleInnerContent(this)">
            1.6 Other data sources and APIs
          </label>
          <div class="inner-content hidden">
            <p>The software platform may need to integrate with other software platforms used by the facility to operate and manage.</p>
            <textarea id="otherDataSources" style="height:180px;">
* The software platform must have the ability to collect dynamic and static data from multiple sources (e.g., BACnet, Modbus, OPC, CSV, RDBMS, and SQL).
* The technology will integrate with multiple external data sources such as local or on-site weather stations or third-party weather providers. Degree-days will be calculated automatically and charted for inclusion in year-to-year or month-to-month energy comparisons. 
* The technology will integrate with existing lighting control and plug control systems so these data sources are available for analysis and diagnostics. [List the lighting control and/or plug load control systems.]
* The technology will integrate with the owner’s CMMS. [Indicate the CMMS vendor.]
* The technology will integrate with existing IoT-based sensing so these data sources are available for analysis and diagnostics. [List the sensing technologies and communication protocols.]
* Provision of an API to support integration of data and fault findings with the third-party applications such as business intelligence software or other accounting systems.
            </textarea>
          </div>
        </div>
        <!-- 1.7 Data validation -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_1_7" onchange="toggleInnerContent(this)">
            1.7 Data validation
          </label>
          <div class="inner-content hidden">
            <p>The data connection to the EMIS will be validated by the EMIS vendor. In case of a data connection interruption, the data should be stored locally for at least two weeks of hourly data, or one week of sub-hourly data (e.g., 15-minute or 5-minute data).</p>
            <p>The technology will detect meter and sensor data quality issues such as gaps, spikes, and flat-lines, and the technology provider will have an option or service to automatically fill and/or correct data.</p>
            <p>The EMIS vendor will help to identify inaccurate data.</p>
            <p>The EMIS vendor will address insufficient data collection intervals, false negative and false positive diagnostics, dropped communications, and erroneous metadata tagging.</p>
          </div>
        </div>
      </div>

      <!-- Tab 2: Utility Bill Analytics -->
      <div id="tab2" class="tab-content hidden">
        <!-- 2.1 Utility bill management -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_2_1" onchange="toggleInnerContent(this)">
            2.1 Utility bill management
          </label>
          <div class="inner-content hidden">
            <p>The technology will provide the capability to allocate utility costs to different tenants or occupant groups sharing a building, to enable recharges and tenant billing.</p>
            <p>The technology will provide capabilities for savings analysis and comparison across a building portfolio through benchmarking, deriving energy use intensity, aligning bills with a calendar month, and normalizing usage based on weather data using standard protocols such as IPMVP Option C.</p>
          </div>
        </div>
        <!-- 2.2 Utility budgeting -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_2_2" onchange="toggleInnerContent(this)">
            2.2 Utility budgeting
          </label>
          <div class="inner-content hidden">
            <p>The technology will chart and report energy costs against budget, indicating surplus/deficit.</p>
            <p>The technology will include custom utility tariffs for energy cost and demand calculations.</p>
          </div>
        </div>
        <!-- 2.3 Greenhouse gas (GHG) tracking -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_2_3" onchange="toggleInnerContent(this)">
            2.3 Greenhouse gas (GHG) tracking
          </label>
          <div class="inner-content hidden">
            <p>The technology will calculate, monitor, and report GHG emissions associated with facility energy use. The technology will supply recommended GHG conversion factors from a referenceable source, and the software will allow the users to enter their own conversion factors.</p>
            <p>Greenhouse gas calculations will account for on-site renewables, where relevant.</p>
          </div>
        </div>
      </div>

      <!-- Tab 3: Interval Meter Data Analytics -->
      <div id="tab3" class="tab-content hidden">
        <!-- 3.1 Energy consumption tracking -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_3_1" onchange="toggleInnerContent(this)">
            3.1 Energy consumption tracking
          </label>
          <div class="inner-content hidden">
            <p>The technology will track and provide flexible charting capabilities for multiple meters on an hourly or sub hourly (e.g., 15-minute) basis.</p>
            <textarea id="energyConsumptionTracking" style="height:130px;">
o	Whole-building level: electricity, gas, water, steam, etc. 
o	End-use submetered level: Pumping system, Air Compressors, HVAC, lighting, etc.
o	Equipment submetered level: chiller, boiler, cooling tower, pump, etc.
o	Renewable energy sources: Solar photovoltaic, biogas, etc.
            </textarea>
            <p>Energy cost tracking</p>
            <ul>
              <li>The technology will calculate and provide visualizations of near real-time/daily/monthly and historic energy costs.</li>
              <li>The technology will use facility-specific tariffs in $/energy unit.</li>
            </ul>
            <p>Energy unit conversion</p>
            <ul>
              <li>The technology will have the ability to normalize the data according to factors that are known to affect energy consumption, such as production rates, floor area, hours of operation, heating degree days, and cooling degree days.</li>
              <li>The technology will have the capability to convert, display, and report energy use in total GJ and additional environmental metrics such as CO2 equivalent.</li>
            </ul>
          </div>
        </div>
        <!-- 3.2 Energy performance analysis -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_3_2" onchange="toggleInnerContent(this)">
            3.2 Energy performance analysis
          </label>
          <div class="inner-content hidden">
            <p>Time series load profiling</p>
            <ul>
              <li>The technology will provide plots of at least 168-hour periods of hourly (or more frequent) interval energy usage versus time.</li>
              <li>The technology will provide options to select the time period and data points that are plotted.</li>
              <li>The technology will allow multiple user-selected data points to be plotted on a single chart or graph.</li>
            </ul>
            <p>Benchmarking</p>
            <p>Benchmarking using the following meter-level key performance indicators (KPIs) will be included in the EMIS for the following metrics. The technology will allow the user to add custom KPIs and custom normalization factors. The benchmarks will be configured to allow for comparison to the prior [day/week/month/year].</p>
            <p>Baseline energy consumption modeling</p>
            <ul>
              <li>The technology will characterize and predict the typical or expected energy usage based on key drivers such as weather (degree days or outside air temperature), production, time of day/week, and other variables.</li>
              <li>The baseline will be used for energy savings calculations, near-future load predictions, energy use comparisons, and energy anomaly detection.</li>
              <li>The technology has the capability to set up multiple baselines, e.g., prior year and a corporate goal baseline.</li>
            </ul>
            <p>Energy anomaly detection</p>
            <ul>
              <li>The technology will identify and flag unexpectedly high or low energy use at the whole-facility and each submeter.</li>
              <li>The technology will allow for energy anomaly detection thresholds to be user-defined.</li>
              <li>The technology will provide the ability to track energy anomalies (duration and persistence) to facilitate response and resolution.</li>
            </ul>
            <p>Building energy dashboards and reports</p>
            <ul>
              <li>The technology provider will provide a public-facing configurable dashboard display for occupants and visitors to view owner-defined aspects of energy consumed in the facility, including energy use intensity, and cumulative savings over time.</li>
              <li>The technology provider will provide an operator-facing or energy manager-facing configurable dashboard display to view building energy performance.</li>
              <li>The technology provider will provide all necessary hardware, software, and connectivity for users to create their own shareable reports.</li>
            </ul>
            <p>Demand monitoring</p>
            <ul>
              <li>The technology will provide daily/monthly/annual peak load monitoring.</li>
              <li>The technology will provide notification through e-mail, or text message to an individual and/or group of recipients when the demand for critical metered loads passes a threshold.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Tab 4: System Data Analytics -->
      <div id="tab4" class="tab-content hidden">
        <!-- 4.1 Fault and Optimization Opportunity Detection -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_4_1" onchange="toggleInnerContent(this)">
            4.1 Fault and Optimization Opportunity Detection
          </label>
          <div class="inner-content hidden">
            <p>The technology will provide fault and optimization opportunity detection capabilities.</p>
          </div>
        </div>
        <!-- 4.2 Fault and Opportunity Diagnosis -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_4_2" onchange="toggleInnerContent(this)">
            4.2 Fault and Opportunity Diagnosis
          </label>
          <div class="inner-content hidden">
            <p>The technology will diagnose faults and identify opportunities for improvement.</p>
          </div>
        </div>
        <!-- 4.3 FDD Configuration -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_4_3" onchange="toggleInnerContent(this)">
            4.3 FDD Configuration
          </label>
          <div class="inner-content hidden">
            <p>The technology will support configuration of FDD settings.</p>
          </div>
        </div>
        <!-- 4.4 Fault management and FDD results presentation -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_4_4" onchange="toggleInnerContent(this)">
            4.4 Fault management and FDD results presentation
          </label>
          <div class="inner-content hidden">
            <p>The technology will present fault management data in a user‑friendly format.</p>
          </div>
        </div>
        <!-- 4.5 Work order management -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_4_5" onchange="toggleInnerContent(this)">
            4.5 Work order management
          </label>
          <div class="inner-content hidden">
            <p>The technology will integrate with work order systems for managing detected faults.</p>
          </div>
        </div>
        <!-- 4.6 System-level diagnostic supports -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_4_6" onchange="toggleInnerContent(this)">
            4.6 System-level diagnostic supports
          </label>
          <div class="inner-content hidden">
            <p>The technology will provide system‑level diagnostic support capabilities.</p>
          </div>
        </div>
      </div>

      <!-- Tab 5: Automated System Optimization -->
      <div id="tab5" class="tab-content hidden">
        <!-- 5.1 HVAC performance optimization -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_5_1" onchange="toggleInnerContent(this)">
            5.1 HVAC performance optimization
          </label>
          <div class="inner-content hidden">
            <p>The technology will optimize HVAC performance through automated controls.</p>
          </div>
        </div>
        <!-- 5.2 Peak demand charge minimization -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_5_2" onchange="toggleInnerContent(this)">
            5.2 Peak demand charge minimization
          </label>
          <div class="inner-content hidden">
            <p>The technology will minimize peak demand charges by adjusting loads in real time.</p>
          </div>
        </div>
        <!-- 5.3 Provision of grid services -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_5_3" onchange="toggleInnerContent(this)">
            5.3 Provision of grid services
          </label>
          <div class="inner-content hidden">
            <p>The technology will enable the provision of grid services where applicable.</p>
          </div>
        </div>
        <!-- 5.4 Other supervisory control strategies -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_5_4" onchange="toggleInnerContent(this)">
            5.4 Other supervisory control strategies
          </label>
          <div class="inner-content hidden">
            <p>The technology will support additional supervisory control strategies as required.</p>
          </div>
        </div>
      </div>

      <!-- Tab 6: Project Management and Reporting -->
      <div id="tab6" class="tab-content hidden">
        <!-- 6.1 Project management and verification of savings -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_6_1" onchange="toggleInnerContent(this)">
            6.1 Project management and verification of savings
          </label>
          <div class="inner-content hidden">
            <p>The technology will provide the capability to log and track the status of energy efficiency projects (e.g., start, ongoing, finish) and personnel assigned. It will allow users to annotate charts and displays with key events and store those annotations.</p>
            <p>The technology will provide measurement and verification (M&amp;V) capabilities in accordance with the International Protocol for Measurement and Verification Protocol (IPMVP) Option C or other industry standards, such as ASHRAE Guideline 14. The baseline model type should be described in the proposal, and preferably adhere to transparent/documented model specifications. Additional requirements include:</p>
            <ul>
              <li>Provision of baseline model fitness metrics (e.g., NMBE, CV[RMSE], R2)</li>
              <li>Ability to create multiple baseline models for a single meter</li>
              <li>Ability to perform M&amp;V using monthly and interval data</li>
              <li>Ability to convert savings to common units (e.g., GJ, $) and normalize (e.g., GJ/sq ft/yr or GJ/unit of production)</li>
              <li>Ability to use ambient temperature data within the baseline models</li>
              <li>Ability to acquire other independent variable data, such as production rate, hours of operation, etc.</li>
            </ul>
            <p>The technology will provide the ability to express savings for each discrete project or in aggregate at the whole-building meter or submeter level, for a defined pre- and post- period or as a cumulative aggregated total. Output and charting requirements include: time-series charts including actual and predicted energy use, cumulative sum of energy savings charts (CUSUM), and energy savings report tables.</p>
            <p>The technology will provide capabilities to support savings analysis using IPMVP Option B.</p>
          </div>
        </div>
        <!-- 6.2 Notification, reporting and data export -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_6_2" onchange="toggleInnerContent(this)">
            6.2 Notification, reporting and data export
          </label>
          <div class="inner-content hidden">
            <p>The technology will provide customizable notification schemes including: work order generation, e-mail, phone, text message, to individual and/or group recipients for data quality alerting, anomaly detection, and fault detection.</p>
            <p>The technology will provide year-over-year energy, cost, and/or equipment health and performance reports in a format specified or acceptable by the facility.</p>
            <p>The technology will provide users the ability to create and save custom reports.</p>
            <p>The technology will export reports to the following file formats [specify which]:</p>
            <ul>
              <li><input type="checkbox" id="export_pdf"> .pdf</li>
              <li><input type="checkbox" id="export_doc"> .doc/.docx</li>
              <li><input type="checkbox" id="export_html"> .html</li>
            </ul>
            <p>The technology will allow users to export data (all, or selected points or totalizations) to the following file formats:</p>
            <ul>
              <li>.xlsx/.xls</li>
              <li>.csv</li>
              <li>.xml</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Tab 7: IT Requirements -->
      <div id="tab7" class="tab-content hidden">
        <!-- 7.1 Data storage and backup -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_7_1" onchange="toggleInnerContent(this)">
            7.1 Data storage and backup
          </label>
          <div class="inner-content hidden">
            <p>The technology will ensure robust data storage and backup solutions.</p>
          </div>
        </div>
        <!-- 7.2 Software hosting and data ownership -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_7_2" onchange="toggleInnerContent(this)">
            7.2 Software hosting and data ownership
          </label>
          <div class="inner-content hidden">
            <p>Hosting arrangements and data ownership protocols will be clearly defined.</p>
          </div>
        </div>
        <!-- 7.3 Cybersecurity -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_7_3" onchange="toggleInnerContent(this)">
            7.3 Cybersecurity
          </label>
          <div class="inner-content hidden">
            <p>Robust cybersecurity measures will be incorporated.</p>
          </div>
        </div>
        <!-- 7.4 Permissions and access control -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_7_4" onchange="toggleInnerContent(this)">
            7.4 Permissions and access control
          </label>
          <div class="inner-content hidden">
            <p>Role‑based permissions and secure access control will be provided.</p>
          </div>
        </div>
        <!-- 7.5 Usability -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_7_5" onchange="toggleInnerContent(this)">
            7.5 Usability
          </label>
          <div class="inner-content hidden">
            <p>The technology will be designed for ease of use and intuitive operation.</p>
          </div>
        </div>
        <!-- 7.6 Networking -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_7_6" onchange="toggleInnerContent(this)">
            7.6 Networking
          </label>
          <div class="inner-content hidden">
            <p>Networking requirements for connectivity and performance will be met.</p>
          </div>
        </div>
      </div>

      <!-- Tab 8: Technical Warranty, Support and Training -->
      <div id="tab8" class="tab-content hidden">
        <!-- 8.1 Warranty -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_8_1" onchange="toggleInnerContent(this)">
            8.1 Warranty
          </label>
          <div class="inner-content hidden">
            <p>A defined warranty period with specified terms will be provided.</p>
          </div>
        </div>
        <!-- 8.2 Technical support -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_8_2" onchange="toggleInnerContent(this)">
            8.2 Technical support
          </label>
          <div class="inner-content hidden">
            <p>Technical support, including service level agreements, will be offered.</p>
          </div>
        </div>
        <!-- 8.3 Training -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_8_3" onchange="toggleInnerContent(this)">
            8.3 Training
          </label>
          <div class="inner-content hidden">
            <p>Training for end users and technical staff will be provided.</p>
          </div>
        </div>
        <!-- 8.4 Testing and Commissioning -->
        <div class="section">
          <label class="include">
            <input type="checkbox" id="include_8_4" onchange="toggleInnerContent(this)">
            8.4 Testing and Commissioning
          </label>
          <div class="inner-content hidden">
            <p>Testing and commissioning protocols and procedures will be outlined.</p>
          </div>
        </div>
      </div>
      
      <!-- NEW: Generate Report button at the bottom of page2 -->
      <div class="page2-buttons">
        <button type="button" onclick="generateReport()">Generate Report</button>
      </div>
    </div>

    <!-- Report Output Page -->
    <div id="reportSection" class="page hidden">
      <h1>Generated Report</h1>
      <div id="reportOutput" class="report-output"></div>
      <div class="report-buttons">
        <button onclick="downloadReport()">Download Report as .doc</button>
        <button onclick="uploadReport()">Upload Report to SharePoint</button>
        <button onclick="showPage('page2')">Back to Survey</button>
      </div>
    </div>
  </div>

  <script>

    let applicationIds = []; // Global variable to store Application IDs

    /***** Basic Survey Functions *****/
    // Toggle the reduction percentage textbox on Technical Objectives page
    function togglePercentage() {
      var checkbox = document.getElementById('obj2');
      var textbox = document.getElementById('reductionPercentage');
      if (checkbox.checked) {
        textbox.classList.remove('hidden');
      } else {
        textbox.classList.add('hidden');
        textbox.value = "";
      }
    }
    
    // Toggle the minutes input for 1.2 if Sub-hourly is selected
    function toggleMinutesInput() {
      var radios = document.getElementsByName('interval_1_2');
      var span = document.getElementById('minutesInputSpan');
      for (var i = 0; i < radios.length; i++) {
        if (radios[i].checked && radios[i].value === "Sub-hourly") {
          span.classList.remove('hidden');
          return;
        }
      }
      span.classList.add('hidden');
      document.getElementById('subhourlyMinutes').value = "";
    }
    
    // Show a specific page
    function showPage(pageId) {
      document.getElementById('org-page').classList.add('hidden');
      document.getElementById('page1').classList.add('hidden');
      document.getElementById('page2').classList.add('hidden');
      document.getElementById('reportSection').classList.add('hidden');
      document.getElementById(pageId).classList.remove('hidden');
    }
    
    // Main tab switching functionality
    function openTab(tabId, event) {
      var tabs = document.getElementsByClassName('tab-content');
      for (var i = 0; i < tabs.length; i++) {
        tabs[i].classList.add('hidden');
      }
      document.getElementById(tabId).classList.remove('hidden');
      
      var tabButtons = document.querySelectorAll('.tabs button');
      tabButtons.forEach(function(btn) {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
    }
    
    // Add submeter bullet point for 1.2
    function addSubmeter() {
      var input = document.getElementById('submeters_1_2');
      var value = input.value.trim();
      if (value !== "") {
        var ul = document.getElementById('submetersList');
        var li = document.createElement('li');
        li.textContent = value;
        ul.appendChild(li);
        input.value = "";
      }
    }
    
    // Gather which utility checkboxes were selected in 1.1
    function selectedUtilityOptions() {
      var arr = [];
      if(document.getElementById('utility_electricity_tab1').checked) arr.push("Electricity");
      if(document.getElementById('utility_naturalGas_tab1').checked) arr.push("Natural Gas");
      if(document.getElementById('utility_propane_tab1').checked) arr.push("Propane");
      if(document.getElementById('utility_steam_tab1').checked) arr.push("Steam");
      if(document.getElementById('utility_chilledWater_tab1').checked) arr.push("Chilled Water");
      if(document.getElementById('utility_water_tab1').checked) arr.push("Water");
      if(document.getElementById('utility_wasteWater_tab1').checked) arr.push("Waste Water");
      if(document.getElementById('utility_compressedAir_tab1').checked) arr.push("Compressed Air");
      if(document.getElementById('utility_renewableEnergy_tab1').checked) arr.push("Renewable Energy");
      if(arr.length === 0) return "";
      return "<p>Selected options: " + arr.join(", ") + "</p>";
    }
    
    // Build the text for 1.2 Interval sub-meter data integration using proper HTML structure
    function buildIntervalSubmeterText() {
      var ul = document.getElementById('submetersList');
      var bulletPoints = "";
      for (var i = 0; i < ul.children.length; i++) {
        bulletPoints += "<li>" + ul.children[i].textContent + "</li>";
      }
      var intervalText = "";
      var radios = document.getElementsByName('interval_1_2');
      for(var i = 0; i < radios.length; i++) {
        if(radios[i].checked) {
          if(radios[i].value === "Hourly") {
            intervalText = "The desired data collection interval will be hourly.";
          } else {
            var mins = document.getElementById('subhourlyMinutes').value || "5";
            intervalText = "The desired data collection interval will be sub-hourly (e.g., " + mins + "-minute data).";
          }
          break;
        }
      }
      var text = "";
      text += "<p>The technology will integrate with new and existing meters and monitoring systems from an interval meter and/or meters with pulse outputs. Where it is necessary to take advantage of existing metering data, the technology will integrate with the following systems for whole facility meters and/or submeters:</p>";
      if(bulletPoints) {
        text += "<ul>" + bulletPoints + "</ul>";
      }
      text += "<p>* " + intervalText + "</p>";
      text += "<p>* Data should be available for analysis in real or near-real time through a continuous and automated data acquisition process.</p>";
      text += "<p>* The technology will have the capability to consolidate meter readings to create virtual meter points. In other words, it can add and subtract the readings from multiple meters at the same interval, to produce a calculated time series of energy use.</p>";
      text += "<p>* The technology will be able to upload and store a minimum history of 5 years of energy use or other data from standard spreadsheet or text file formats.</p>";
      text += "<p>* The technology will have the capacity to store at least 5 years of data, trended at intervals up to 15 minutes for analysis, reporting, and visualization.</p>";
      text += "<p>* The technology will have the ability to parse out data cluster displays into coincident time intervals ranging from 10 minutes to 1 year.</p>";
      return text;
    }
    
    // Build the text for 1.3 BAS integration using proper HTML structure
    function buildBASIntegrationText() {
      var arrDataInclude = [];
      if(document.getElementById('bas_chillerBoiler_1_3').checked) arrDataInclude.push("chiller/boiler plant data");
      if(document.getElementById('bas_airHandler_1_3').checked) arrDataInclude.push("air handler data");
      if(document.getElementById('bas_zoneDevice_1_3').checked) arrDataInclude.push("zone device data");
      var arrIntegration = [];
      if(document.getElementById('bas_energyMeter_1_3').checked) arrIntegration.push("energy meter data already connected into the BAS");
      if(document.getElementById('bas_equipmentStatus_1_3').checked) arrIntegration.push("equipment status");
      if(document.getElementById('bas_setpoints_1_3').checked) arrIntegration.push("setpoints");
      if(document.getElementById('bas_valveSignals_1_3').checked) arrIntegration.push("valve/damper control signals");
      if(document.getElementById('bas_fanSpeed_1_3').checked) arrIntegration.push("fan speed");
      if(document.getElementById('bas_airFlow_1_3').checked) arrIntegration.push("air flow rate");
      if(document.getElementById('bas_pumpFlow_1_3').checked) arrIntegration.push("pump water flow rate");
      if(document.getElementById('bas_temperatures_1_3').checked) arrIntegration.push("air and water temperatures");
    
      var text = "";
      text += "<p>* The technology will extract data from the building control systems for Fault Detection and Diagnostics (FDD) functions.</p>";
      text += "<p>* The data collection interval will be selected to meet the needs of the FDD software and is compatible with BAS trending, with 15-minute interval data being the most implemented. Change of value and/or slower polling rates may be needed to reduce network burden on the control system, and the effect of data collection interval on network speed will be determined during FDD setup. Slower or faster polling rates may also be implemented based on the type of fault (e.g., hunting and cycling faults may need one- to five-minute interval data).</p>";
      text += "<p>* Integration with non-legacy vintages of BAS providers will occur via common protocols such as BACnet and Modbus, or through the BAS vendor’s gateway. If the BAS does not support BACnet, a data gateway or protocol converter will need to be installed by the EMIS vendor.</p>";
      text += "<p>* BAS data will be integrated as follows:</p>";
      text += "<p>** These data include:</p>";
      text += "<ul><li>" + (arrDataInclude.length > 0 ? arrDataInclude.join(", ") : "(none)") + "</li></ul>";
      text += "<p>** Integration will include but not be limited to:</p>";
      text += "<ul><li>" + (arrIntegration.length > 0 ? arrIntegration.join(", ") : "(none)") + "</li></ul>";
      text += "<p>* Near-real time data polling or end of day batch uploads to the EMIS are acceptable.</p>";
      text += "<p>* The data integration will not adversely affect the speed of the existing BAS control or visualization functions.</p>";
      return text;
    }
    
    // // Build the text for 1.4 Additional monitoring using proper HTML structure
    // function buildAdditionalMonitoringText() {
    //   return "<ul>" +
    //          "<li>Major energy end uses (panel level): Switchgear panel, etc.</li>" +
    //          "<li>Equipment level energy end uses: chiller, boiler, cooling towers, pumps, compressors, air handlers, major electromotors, etc.</li>" +
    //          "<li>Functional area/zones of building/plant energy end uses: chiller plant, compressed air system, etc.</li>" +
    //          "<li>Additional building automation system or process control points</li>" +
    //          "</ul>";
    // }
    
    // Build the text for 3.1 Energy consumption tracking using proper HTML structure
    function build3_1Text() {
      var text = "<p>The technology will track and provide flexible charting capabilities for multiple meters on an hourly or sub hourly (e.g., 15-minute) basis.</p>";
      var trackingText = document.getElementById('energyConsumptionTracking').value.trim();
      trackingText = trackingText.replace(/\n/g, "<br>");
      text += "<p>" + trackingText + "</p>";
      text += "<p>* Energy cost tracking</p>";
      text += "<ul>" +
              "<li>The technology will calculate and provide visualizations of near real-time/daily/monthly and historic energy costs.</li>" +
              "<li>The technology will use facility-specific tariffs in $/energy unit.</li>" +
              "</ul>";
      text += "<p>* Energy unit conversion</p>";
      text += "<ul>" +
              "<li>The technology will have the ability to normalize the data according to factors that are known to affect energy consumption, such as production rates, floor area, hours of operation, heating degree days, and cooling degree days.</li>" +
              "<li>The technology will have the capability to convert, display, and report energy use in total GJ and additional environmental metrics such as CO2 equivalent.</li>" +
              "</ul>";
      return text;
    }
    
    // Get selected export formats for reports (6.2)
    function getExportFormats() {
      var formats = [];
      if(document.getElementById('export_pdf').checked) formats.push(".pdf");
      if(document.getElementById('export_doc').checked) formats.push(".doc/.docx");
      if(document.getElementById('export_html').checked) formats.push(".html");
      return formats.join(", ");
    }
    
    // Toggle inner content display based on outer "Include" checkbox
    function toggleInnerContent(checkbox) {
      var inner = checkbox.parentElement.nextElementSibling;
      if (inner && inner.classList.contains("inner-content")) {
        if (checkbox.checked) {
          inner.classList.remove("hidden");
        } else {
          inner.classList.add("hidden");
        }
      }
    }
    
    /***** Report Generation *****/
    function generateReport() {
      var report = "";
      report += "<h2 style='color:#007BFF;'>Energy Management Information Systems (EMIS)</h2>";
      report += "<p>An Energy Management Information System (EMIS) provides your organization with relevant information to enhance energy performance   visibility to manage and control energy use in relation to production. This enables effective planning and decision-making regarding energy management, continuous improvement, and driving significant energy efficiency and cost savings.  An EMIS foundation is built on three key elements:</p>";
      report += "<ol><li>Data capture and storage</li><li>Analysis</li><li>Reporting and notifications</li></ol>";
      report += "<p>A well-designed EMIS equips your facility operators with actionable insights to optimize energy efficiency and improve overall operational performance.</p>";
      report += "<p>Implementing EMIS has led to significant energy and cost savings across various Canadian industries. For example, New Gold's New Afton Mine in British Columbia implemented an EMIS to monitor over 160 energy consumption data points, including 157 electrical sub-meters and 6 gas meters. This initiative enabled the mine to achieve ISO 50001 energy certification in 2014, marking it as the first mining facility in North America to do so. More references of EMIS implementations can be found in Energy management information systems - Natural Resources Canada</p>";
      report += "<p>For your facility, which currently does not have an EMIS, it is recommended to implement a system that includes real-time monitoring and data collection, utility billing and data analytics, performance benchmarking, energy consumption forecasting, automated alerts and notifications, automated controls and optimization, energy performance reporting, and integration with production and facility systems. This comprehensive EMIS will provide the necessary tools to monitor, analyze, and manage energy consumption effectively, supporting the facility's energy management goals and driving continuous improvement.</p>";
      
      report += "<p>During the site visit, the following features were selected:</p>";
      report += "<ul>";
      if(document.getElementById('obj1').checked) report += "<li>Facilitate continuous energy management and increased operational efficiency</li>";
      if(document.getElementById('obj2').checked) {
        var perc = document.getElementById('reductionPercentage').value || "five";
        report += "<li>Enable the organization to reduce portfolio energy use by " + perc + " percent</li>";
      }
      if(document.getElementById('obj3').checked) report += "<li>Automate energy performance analysis using an energy information system</li>";
      if(document.getElementById('obj4').checked) report += "<li>Perform automated fault detection and diagnostics (FDD) for the HVAC system</li>";
      if(document.getElementById('obj5').checked) report += "<li>Achieve automated system optimization with the EMIS software performing supervisory control to supplement the BAS</li>";
      if(document.getElementById('obj6').checked) report += "<li>Track the impact of energy efficiency projects, and measure and verify savings</li>";
      if(document.getElementById('obj7').checked) report += "<li>Track and manage peak demand</li>";
      if(document.getElementById('obj8').checked) report += "<li>Produce reports for energy and utility management, operations, and maintenance</li>";
      if(document.getElementById('obj9').checked) report += "<li>Support implementation of ISO 50001 Ready</li>";
      if(document.getElementById('obj10').checked) report += "<li>Manage GHG emission monitoring and subsequent reporting</li>";
      report += "</ul>";
      
      report += "<p>Based on the features, we propose the implementation of an EMIS system as outlined below.</p>";
    //   report += "<ul>";
      
      // Section 1: Data Integration
      if(document.getElementById("include_1_1").checked || document.getElementById("include_1_2").checked || document.getElementById("include_1_3").checked || document.getElementById("include_1_4").checked || document.getElementById("include_1_5").checked || document.getElementById("include_1_6").checked || document.getElementById("include_1_7").checked){
      report += "<li><strong>1. Data Integration</strong>";
      report += "<ul>";
      if(document.getElementById("include_1_1").checked) {
         report += "<li><strong>1.1 Utility data integration</strong>";
         report += "<p>The technology will provide the capability to integrate utility meter data from existing systems:</p>";
         report += selectedUtilityOptions();
         report += "</li>";
      }
      if(document.getElementById("include_1_2").checked) {
         report += "<li><strong>1.2 Interval sub-meter data integration</strong>";
         report += buildIntervalSubmeterText();
         report += "</li>";
      }
      if(document.getElementById("include_1_3").checked) {
         report += "<li><strong>1.3 Building automation system (BAS) data integration</strong>";
         report += buildBASIntegrationText();
         report += "</li>";
      }
      if(document.getElementById("include_1_4").checked) {
        var otherText = document.getElementById('additionalMonitoring').value.trim();
        otherText = otherText.replace(/\n/g, "<br>");
         report += "<li><strong>1.4 Additional monitoring required or preferred</strong>";
        report += "<p></p>";
        //  report += buildAdditionalMonitoringText();
        report += "<p>" + otherText + "</p>";
         report += "</li>";
      }
      if(document.getElementById("include_1_5").checked) {
         report += "<li><strong>1.5 Metadata / data tagging</strong>";
         report += "<p>The use of standard naming conventions and a metadata schema (which may be referred to as ‘data tags’) improves the ability of the EMIS to consistently analyze, visualize, and derive value from operational data. A metadata schema will be selected for the EMIS project, defining at a minimum: </p>";
         report += "<p>•  a data dictionary for all terms used in the schema;</p>";
         report += "<p>•  a data taxonomy, providing categories and subcategories for the defined terms;</p>";
         report += "<p>The specific version of the metadata schema should be noted, as well as noting whether the schema is an adaptation or extension of another existing schema.</p>";
         report += "<p>The EMIS vendor will provide appropriate metadata for all data integrated with the EMIS, in alignment with the schema or tagging system selected for the project.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_1_6").checked) {
         var otherText = document.getElementById('otherDataSources').value.trim();
         otherText = otherText.replace(/\n/g, "<br>");
         report += "<li><strong>1.6 Other data sources and APIs</strong>";
         report += "<p>" + otherText + "</p>";
         report += "</li>";
      }
      if(document.getElementById("include_1_7").checked) {
         report += "<li><strong>1.7 Data validation</strong>";
         report += "<p>* The data connection to the EMIS will be validated by the EMIS vendor. In case of a data connection interruption, the data should be stored locally for at least two weeks of hourly data, or one week of sub-hourly data (e.g., 15-minute or 5-minute data).</p>";
         report += "<p>* The technology will detect meter and sensor data quality issues such as gaps, spikes, and flat-lines, and the technology provider will have an option or service to automatically fill and/or correct data.</p>";
         report += "<p>* The EMIS vendor will help to identify inaccurate data.</p>";
         report += "<p>* The EMIS vendor will address insufficient data collection intervals, false negative and false positive diagnostics, dropped communications, and erroneous metadata tagging.</p>";
         report += "</li>";
      }
      report += "</ul></li>";
    }
      
      // Section 2: Utility Bill Analytics
      if(document.getElementById("include_2_1").checked || document.getElementById("include_2_2").checked || document.getElementById("include_2_3").checked){
      report += "<li><strong>2. Utility Bill Analytics</strong>";
      report += "<ul>";
      if(document.getElementById("include_2_1").checked) {
         report += "<li><strong>2.1 Utility bill management</strong>";
         report += "<p>* The technology will provide the capability to allocate utility costs to different tenants or occupant groups sharing a building, to enable recharges and tenant billing.</p>";
         report += "<p>* The technology will provide capabilities for savings analysis and comparison across a building portfolio through benchmarking, deriving energy use intensity, aligning bills with a calendar month, and normalizing usage based on weather data using standard protocols such as IPMVP Option C.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_2_2").checked) {
         report += "<li><strong>2.2 Utility budgeting</strong>";
         report += "<p>* The technology will chart and report energy costs against budget, indicating surplus/deficit.</p>";
         report += "<p>* The technology will include custom utility tariffs for energy cost and demand calculations.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_2_3").checked) {
         report += "<li><strong>2.3 Greenhouse gas (GHG) tracking</strong>";
         report += "<p>* The technology will calculate, monitor, and report GHG emissions associated with facility energy use. The technology will supply recommended GHG conversion factors from a referenceable source, and the software will allow the users to enter their own conversion factors.</p>";
         report += "<p>* Greenhouse gas calculations will account for on-site renewables, where relevant.</p>";
         report += "</li>";
      }
      report += "</ul></li>";
    }
      
      // Section 3: Interval Meter Data Analytics
      if(document.getElementById("include_3_1").checked || document.getElementById("include_3_2").checked){
      report += "<li><strong>3. Interval Meter Data Analytics</strong>";
      report += "<ul>";
      if(document.getElementById("include_3_1").checked) {
         report += "<li><strong>3.1 Energy consumption tracking</strong>";
         report += build3_1Text();
         report += "</li>";
      }
      if(document.getElementById("include_3_2").checked) {
         report += "<li><strong>3.2 Energy performance analysis</strong>";
            report += "<p>* Time series load profiling</p>";
report += "<ul>";
report += "<li>The technology will provide plots of at least 168-hour periods of hourly (or more frequent) interval energy usage versus time.</li>";
report += "<li>The technology will provide options to select the time period and data points that are plotted.</li>";
report += "<li>The technology will allow multiple user-selected data points to be plotted on a single chart or graph.</li>";
report += "</ul>";
report += "<p>* Benchmarking</p>";
report += "<p>Benchmarking using the following meter-level key performance indicators (KPIs) will be included in the EMIS for the following metrics. The technology will allow the user to add custom KPIs and custom normalization factors. The benchmarks will be configured to allow for comparison to the prior [day/week/month/year].</p>";
report += "<p>* Baseline energy consumption modeling</p>";
report += "<ul>";
report += "<li>The technology will characterize and predict the typical or expected energy usage based on key drivers such as weather (degree days or outside air temperature), production, time of day/week, and other variables.</li>";
report += "<li>The baseline will be used for energy savings calculations, near-future load predictions, energy use comparisons, and energy anomaly detection.</li>";
report += "<li>The technology has the capability to set up multiple baselines, e.g., prior year and a corporate goal baseline.</li>";
report += "</ul>";
report += "<p>* Energy anomaly detection</p>";
report += "<ul>";
report += "<li>The technology will identify and flag unexpectedly high or low energy use at the whole-facility and each submeter.</li>";
report += "<li>The technology will allow for energy anomaly detection thresholds to be user-defined.</li>";
report += "<li>The technology will provide the ability to track energy anomalies (duration and persistence) to facilitate response and resolution.</li>";
report += "</ul>";
report += "<p>* Building energy dashboards and reports</p>";
report += "<ul>";
report += "<li>The technology provider will provide a public-facing configurable dashboard display for occupants and visitors to view owner-defined aspects of energy consumed in the facility, including energy use intensity, and cumulative savings over time.</li>";
report += "<li>The technology provider will provide an operator-facing or energy manager-facing configurable dashboard display to view building energy performance.</li>";
report += "<li>The technology provider will provide all necessary hardware, software, and connectivity for users to create their own shareable reports.</li>";
report += "</ul>";
report += "<p>* Demand monitoring</p>";
report += "<ul>";
report += "<li>The technology will provide daily/monthly/annual peak load monitoring.</li>";
report += "<li>The technology will provide notification through e-mail, or text message to an individual and/or group of recipients when the demand for critical metered loads passes a threshold.</li>";
report += "</ul>";
report += "</li>";
      }
      report += "</ul></li>";
    }
      
      // Section 4: System Data Analytics
      if(document.getElementById("include_4_1").checked || document.getElementById("include_4_2").checked || document.getElementById("include_4_3").checked || document.getElementById("include_4_4").checked || document.getElementById("include_4_5").checked || document.getElementById("include_4_6").checked){
      report += "<li><strong>4. System Data Analytics</strong>";
      report += "<ul>";
      if(document.getElementById("include_4_1").checked) {
         report += "<li><strong>4.1 Fault and Optimization Opportunity Detection</strong>";
         report += "<p>* The technology will provide fault and optimization opportunity detection capabilities.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_4_2").checked) {
         report += "<li><strong>4.2 Fault and Opportunity Diagnosis</strong>";
         report += "<p>* The technology will diagnose faults and identify opportunities for improvement.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_4_3").checked) {
         report += "<li><strong>4.3 FDD Configuration</strong>";
         report += "<p>* The technology will support configuration of FDD settings.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_4_4").checked) {
         report += "<li><strong>4.4 Fault management and FDD results presentation</strong>";
         report += "<p>* The technology will present fault management data in a user‑friendly format.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_4_5").checked) {
         report += "<li><strong>4.5 Work order management</strong>";
         report += "<p>* The technology will integrate with work order systems for managing detected faults.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_4_6").checked) {
         report += "<li><strong>4.6 System-level diagnostic supports</strong>";
         report += "<p>* The technology will provide system-level diagnostic support capabilities.</p>";
         report += "</li>";
      }
      report += "</ul></li>";
    }
      
      // Section 5: Automated System Optimization
      if(document.getElementById("include_5_1").checked || document.getElementById("include_5_2").checked || document.getElementById("include_5_3").checked || document.getElementById("include_5_4").checked){
      report += "<li><strong>5. Automated System Optimization</strong>";
      report += "<ul>";
      if(document.getElementById("include_5_1").checked) {
         report += "<li><strong>5.1 HVAC performance optimization</strong>";
         report += "<p>* The technology will optimize HVAC performance through automated controls.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_5_2").checked) {
         report += "<li><strong>5.2 Peak demand charge minimization</strong>";
         report += "<p>* The technology will minimize peak demand charges by adjusting loads in real time.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_5_3").checked) {
         report += "<li><strong>5.3 Provision of grid services</strong>";
         report += "<p>* The technology will enable the provision of grid services where applicable.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_5_4").checked) {
         report += "<li><strong>5.4 Other supervisory control strategies</strong>";
         report += "<p>* The technology will support additional supervisory control strategies as required.</p>";
         report += "</li>";
      }
      report += "</ul></li>";
    }
      
      // Section 6: Project Management and Reporting
      if(document.getElementById("include_6_1").checked || document.getElementById("include_6_2").checked){
      report += "<li><strong>6. Project Management and Reporting</strong>";
      report += "<ul>";
      if(document.getElementById("include_6_1").checked) {
        report += "<li><strong>6.1 Project management and verification of savings</strong>";
report += "<p>* The technology will provide the capability to log and track the status of energy efficiency projects (e.g., start, ongoing, finish) and personnel assigned. The technology will allow users to annotate charts and displays with key events and will store those annotations.</p>";
report += "<p>* The technology will provide measurement and verification (M&amp;V) capabilities in accordance with the International Protocol for Measurement and Verification Protocol (IPMVP) Option C or other industry standards, such as ASHRAE Guideline 14. The baseline model type should be described in the proposal, and preferably adhere to transparent/documented model specifications. Additional requirements include:</p>";
report += "<ul>";
report += "<li>Provision of baseline model fitness metrics (e.g., NMBE, CV[RMSE], R2)</li>";
report += "<li>Ability to create multiple baseline models for a single meter</li>";
report += "<li>Ability to perform M&amp;V using monthly and interval data</li>";
report += "<li>Ability to convert savings to common units (e.g., GJ, $) and normalize (e.g., GJ/sq ft/yr or GJ/unit of production)</li>";
report += "<li>Ability to use ambient temperature data within the baseline models</li>";
report += "<li>Ability to acquire other independent variable data, such as production rate, hours of operation, etc. These data may be entered manually or acquired from a facility-level system</li>";
report += "</ul>";
report += "<p>* The technology will provide the ability to express savings for each discrete project or in aggregate at the whole-building meter or submeter level, for a defined pre- and post- period or as a cumulative aggregated total. Output and charting requirements include: time-series charts including actual and predicted energy use, cumulative sum of energy savings charts (CUSUM), and energy savings report tables.</p>";
report += "<p>* The technology will provide capabilities to support savings analysis using IPMVP Option B.</p>";
report += "</li>";

      }
      if(document.getElementById("include_6_2").checked) {
         report += "<li><strong>6.2 Notification, reporting and data export</strong>";
         report += "<p>* The technology will provide customizable notification schemes including: work order generation, e-mail, phone, text message, to individual and/or group recipients for data quality alerting, anomaly detection, and fault detection.</p>";
         report += "<p>* The technology will provide year-over-year energy, cost, and/or equipment health and performance reports in a format specified or acceptable by the facility.</p>";
         report += "<p>* The technology will provide users the ability to create and save custom reports.</p>";
         report += "<p>* The technology will export reports to the following file formats [specify which]: " + getExportFormats() + "</p>";
         report += "<p>* The technology will allow users to export data (all, or selected points or totalizations) to the following file formats:: .xlsx/.xls, .csv, .xml</p>";
         report += "</li>";
      }
      report += "</ul></li>";
    }
      
      // Section 7: IT Requirements
      if(document.getElementById("include_7_1").checked || document.getElementById("include_7_2").checked || document.getElementById("include_7_3").checked || document.getElementById("include_7_4").checked || document.getElementById("include_7_5").checked || document.getElementById("include_7_6").checked){
      report += "<li><strong>7. IT Requirements</strong>";
      report += "<ul>";
      if(document.getElementById("include_7_1").checked) {
         report += "<li><strong>7.1 Data storage and backup</strong>";
         report += "<p>* Robust data storage and backup solutions will be ensured.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_7_2").checked) {
         report += "<li><strong>7.2 Software hosting and data ownership</strong>";
         report += "<p>* Hosting arrangements and data ownership protocols will be clearly defined.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_7_3").checked) {
         report += "<li><strong>7.3 Cybersecurity</strong>";
         report += "<p>* Robust cybersecurity measures will be incorporated.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_7_4").checked) {
         report += "<li><strong>7.4 Permissions and access control</strong>";
         report += "<p>* Role‑based permissions and secure access control will be provided.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_7_5").checked) {
         report += "<li><strong>7.5 Usability</strong>";
         report += "<p>* The technology will be designed for ease of use and intuitive operation.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_7_6").checked) {
         report += "<li><strong>7.6 Networking</strong>";
         report += "<p>* Networking requirements for connectivity and performance will be met.</p>";
         report += "</li>";
      }
      report += "</ul></li>";
    }
      
      // Section 8: Technical Warranty, Support and Training
      if(document.getElementById("include_8_1").checked || document.getElementById("include_8_2").checked || document.getElementById("include_8_3").checked || document.getElementById("include_8_4").checked){
      report += "<li><strong>8. Technical Warranty, Support and Training</strong>";
      report += "<ul>";
      if(document.getElementById("include_8_1").checked) {
         report += "<li><strong>8.1 Warranty</strong>";
         report += "<p>* A defined warranty period with specified terms will be provided.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_8_2").checked) {
         report += "<li><strong>8.2 Technical support</strong>";
         report += "<p>* Technical support, including service level agreements, will be offered.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_8_3").checked) {
         report += "<li><strong>8.3 Training</strong>";
         report += "<p>* Training for end users and technical staff will be provided.</p>";
         report += "</li>";
      }
      if(document.getElementById("include_8_4").checked) {
         report += "<li><strong>8.4 Testing and Commissioning</strong>";
         report += "<p>* Testing and commissioning protocols and procedures will be outlined.</p>";
         report += "</li>";
      }
      report += "</ul></li>";
    }
    //   report += "</ul>";
      
      // Prepend User Info at the top of the report
      var userInfo = JSON.parse(localStorage.getItem("userInfo"));
      var userInfoHeader = "<h2 style='color:#007BFF;'>Organization Information</h2>";
      userInfoHeader += "<p><strong>Application ID:</strong> " + userInfo.appId + "</p>";
      userInfoHeader += "<p><strong>Organization Name:</strong> " + userInfo.orgName + "</p>";
      userInfoHeader += "<p><strong>Facility Type:</strong> " + userInfo.orgType + "</p>";
      userInfoHeader += "<p><strong>Facility Address:</strong> " + userInfo.siteAddress + "</p>";
      userInfoHeader += "<p><strong>Attendee Names:</strong> " + userInfo.attendeeNames.join(", ") + "</p><hr>";
      
      report = userInfoHeader + report;
      document.getElementById('reportOutput').innerHTML = report;
      showPage('reportSection');
    }
    
    // Download the report as a .doc file with proper Word-readable HTML and adjusted spacing
    function downloadReport() {
      var header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
                   "xmlns:w='urn:schemas-microsoft-com:office:word' " +
                   "xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>EMIS Report</title>" +
                   "<style>" +
                   "body { font-family: 'Roboto', sans-serif; margin: 10px; line-height: 1.6; } " +
                   "h2, h3, h4 { margin-bottom: 15px; } " +
                   "p { margin: 15px 0; } " +
                   "ul { margin: 15px 0 15px 40px; } " +
                   "li { margin-bottom: 10px; }" +
                   "</style></head><body>";
      var footer = "</body></html>";
      var reportText = document.getElementById('reportOutput').innerHTML;
      var sourceHTML = header + reportText + footer;
      var blob = new Blob([sourceHTML], { type: "application/msword" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = "EMIS_Report.doc";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

//     /***** MSAL & SharePoint Upload Functions *****/
//     // Replace the placeholder values with your actual configuration.
//     const msalConfig = {
//       auth: {
//         clientId: "8f1d5ef0-4091-4d3d-9a2f-c01c76f49653",
//         authority: "https://login.microsoftonline.com/1f7fe2e2-239a-46a3-9a57-4e28233d6682",
//         redirectUri: window.location.origin + "/redirect",
//       },
//       cache: {
//         cacheLocation: "localStorage",
//         storeAuthStateInCookie: true,
//       },
//     };
//     const msalInstance = new msal.PublicClientApplication(msalConfig);
//     let isInteractionInProgress = false;
//     async function ensureAuthenticated() {
//       if (isInteractionInProgress) return;
//       try {
//         isInteractionInProgress = true;
//         const accounts = msalInstance.getAllAccounts();
//         if (accounts.length === 0) {
//           await msalInstance.loginPopup({
//             scopes: ["Sites.ReadWrite.All", "Files.ReadWrite.All"],
//           });
//           msalInstance.setActiveAccount(msalInstance.getAllAccounts()[0]);
//         } else {
//           msalInstance.setActiveAccount(accounts[0]);
//         }
//       } catch (error) {
//         console.error("Authentication error:", error);
//         throw error;
//       } finally {
//         isInteractionInProgress = false;
//       }
//     }
//     async function acquireTokenWithInteractionCheck() {
//       try {
//         isInteractionInProgress = true;
//         const accounts = msalInstance.getAllAccounts();
//         if (accounts.length === 0) {
//           const loginResponse = await msalInstance.loginPopup({
//             scopes: ["Sites.ReadWrite.All", "Files.ReadWrite.All"],
//           });
//           msalInstance.setActiveAccount(msalInstance.getAllAccounts()[0]);
//           return loginResponse.accessToken;
//         }
//         const tokenResponse = await msalInstance.acquireTokenSilent({
//           scopes: ["Sites.ReadWrite.All", "Files.ReadWrite.All"],
//           account: accounts[0],
//         });
//         return tokenResponse.accessToken;
//       } catch (error) {
//         if (error instanceof msal.InteractionRequiredAuthError) {
//           const interactiveResponse = await msalInstance.acquireTokenPopup({
//             scopes: ["Sites.ReadWrite.All", "Files.ReadWrite.All"],
//           });
//           return interactiveResponse.accessToken;
//         } else {
//           console.error("Token acquisition error:", error);
//           throw error;
//         }
//       } finally {
//         isInteractionInProgress = false;
//       }
//     }

//     async function getListItemByApplicationId(accessToken, applicationId) {
//   try {
//     const listItemsUrl =
//       "https://graph.microsoft.com/v1.0/sites/enervaca.sharepoint.com:/sites/ERASEMI:/lists/FRA List/items?$expand=fields";

//     const response = await fetch(listItemsUrl, {
//       headers: {
//         Authorization: `Bearer ${accessToken}`,
//         Accept: "application/json",
//       },
//     });

//     if (!response.ok) {
//       throw new Error(
//         `Failed to fetch list items. Status: ${response.status}, Error: ${response.statusText}`
//       );
//     }

//     const data = await response.json();
//     const matchingItem = data.value.find(
//       (item) => item.fields && item.fields.Title === applicationId
//     );

//     if (!matchingItem) {
//       throw new Error(`No matching item found for Application ID: ${applicationId}`);
//     }

//     return matchingItem.fields.DocumentLibrary.Url;
//   } catch (error) {
//     console.error("Error fetching list item by Application ID:", error);
//     throw error;
//   }
// }

//     // Basic upload function – adjust the driveId and folderPath for your SharePoint environment.
//     async function uploadFile(driveId, folderPath, file, accessToken) {
//       const fileName = file.name;
//       const uploadUrl = `https://graph.microsoft.com/v1.0/drives/${driveId}/root:/${folderPath}/EMIS/${fileName}:/content`;
//       try {
//         const response = await fetch(uploadUrl, {
//           method: "PUT",
//           headers: {
//             Authorization: `Bearer ${accessToken}`,
//             "Content-Type": file.type,
//           },
//           body: file,
//         });
//         if (!response.ok) {
//           throw new Error(`Upload failed. Status: ${response.status}`);
//         }
//         const uploadedFile = await response.json();
//         console.log("File uploaded:", uploadedFile);
//         return uploadedFile;
//       } catch (error) {
//         console.error("Upload error:", error);
//         throw error;
//       }
//     }

//     async function fetchApplicationIdsOnStart() {
//   try {
//     // Ensure user is authenticated
//     await ensureAuthenticated();

//     // Acquire access token
//     const accessToken = await acquireTokenWithInteractionCheck();

//     // Fetch the Application IDs from SharePoint
//     const response = await fetch(
//       "https://graph.microsoft.com/v1.0/sites/enervaca.sharepoint.com:/sites/ERASEMI:/lists/FRA List/items?$expand=fields",
//       {
//         headers: {
//           Authorization: `Bearer ${accessToken}`,
//           Accept: "application/json",
//         },
//       }
//     );

//     if (!response.ok) {
//       throw new Error(
//         `Failed to fetch list items. Status: ${response.status}, Error: ${response.statusText}`
//       );
//     }

//     const data = await response.json();

//     // Store Application IDs
//     applicationIds = data.value.map((item) => item.fields.Title); // Assuming the Application ID is in the "Title" field
//     console.log("Fetched Application IDs:", applicationIds);
//   } catch (error) {
//     console.error("Error fetching Application IDs on start:", error);
//     alert("Unable to fetch Application IDs. Please refresh the page.");
//   }
// }

// // Call this function when the application starts
// document.addEventListener("DOMContentLoaded", fetchApplicationIdsOnStart);

const msalConfig = {
    auth: {
        clientId: "8f1d5ef0-4091-4d3d-9a2f-c01c76f49653", // Your Client ID
        authority: "https://login.microsoftonline.com/1f7fe2e2-239a-46a3-9a57-4e28233d6682", // Tenant ID
        redirectUri: window.location.origin + "/redirect", // Ensure this matches app's redirect URI
    },
    cache: {
        cacheLocation: "localStorage", // Store tokens in localStorage
        storeAuthStateInCookie: true, // For cross-browser support
    },
};

const msalInstance = new msal.PublicClientApplication(msalConfig);

function clearPreviousInteractions() {
  const accounts = msalInstance.getAllAccounts();
  accounts.forEach((account) => msalInstance.removeAccount(account));
  console.log("Previous MSAL accounts cleared.");
}

async function uploadFile(driveId, folderPath, file, accessToken) {
  const fileName = file.name; // Get the name of the file
  const uploadUrl = `https://graph.microsoft.com/v1.0/drives/${driveId}/root:/${folderPath}/EMIS/${fileName}:/content`;

  try {
    const response = await fetch(uploadUrl, {
      method: "PUT", // Use PUT for file uploads
      headers: {
        Authorization: `Bearer ${accessToken}`,
        "Content-Type": file.type, // Example: 'application/pdf'
      },
      body: file, // File content
    });

    if (!response.ok) {
      throw new Error(
        `Failed to upload file. Status: ${response.status}, ${response.statusText}`
      );
    }

    const uploadedFile = await response.json();
    console.log("File uploaded successfully:", uploadedFile);
    return uploadedFile;
  } catch (error) {
    console.error("Error uploading file:", error);
    throw error;
  }
}

let isInteractionInProgress = false;

async function ensureAuthenticated() {
  if (isInteractionInProgress) {
    console.warn("Interaction already in progress...");
    return; // Avoid multiple interactions
  }
  try {
    isInteractionInProgress = true;
    const accounts = msalInstance.getAllAccounts();
    if (accounts.length === 0) {
      await msalInstance.loginPopup({
        scopes: ["Sites.ReadWrite.All", "Files.ReadWrite.All"],
      });
      msalInstance.setActiveAccount(msalInstance.getAllAccounts()[0]); // Set active account after login
    } else {
      msalInstance.setActiveAccount(accounts[0]); // Ensure active account is set
    }
  } catch (error) {
    console.error("Error during authentication:", error);
    throw error;
  } finally {
    isInteractionInProgress = false;
  }
}

async function acquireTokenWithInteractionCheck() {
  if (isInteractionInProgress) {
    console.warn("Interaction already in progress...");
    return; // Avoid multiple interactions
  }

  try {
    isInteractionInProgress = true;
    const accounts = msalInstance.getAllAccounts();
    if (accounts.length === 0) {
      console.log("No accounts found. Initiating login...");
      const loginResponse = await msalInstance.loginPopup({
        scopes: ["Sites.ReadWrite.All", "Files.ReadWrite.All"],
      });
      msalInstance.setActiveAccount(msalInstance.getAllAccounts()[0]); // Ensure active account
      return loginResponse.accessToken;
    }

    console.log("Attempting token acquisition silently...");
    const tokenResponse = await msalInstance.acquireTokenSilent({
      scopes: ["Sites.ReadWrite.All", "Files.ReadWrite.All"],
      account: msalInstance.getAllAccounts()[0],
    });
    console.log("Token acquired silently:", tokenResponse.accessToken);
    return tokenResponse.accessToken;
  } catch (error) {
    if (error instanceof msal.InteractionRequiredAuthError) {
      console.warn(
        "Silent token acquisition failed. Fallback to interactive login..."
      );
      const interactiveResponse = await msalInstance.acquireTokenPopup({
        scopes: ["Sites.ReadWrite.All", "Files.ReadWrite.All"],
      });
      console.log(
        "Token acquired via interaction:",
        interactiveResponse.accessToken
      );
      return interactiveResponse.accessToken;
    } else {
      console.error("Error acquiring token:", error);
      throw error;
    }
  } finally {
    isInteractionInProgress = false;
  }
}

// Fetch SharePoint List Items
async function getListItemByApplicationId(accessToken, applicationId) {
  try {
    // The correct endpoint for list items
    const listItemsUrl =
      "https://graph.microsoft.com/v1.0/sites/enervaca.sharepoint.com:/sites/ERASEMI:/lists/FRA List/items?$expand=fields"

    const response = await fetch(listItemsUrl, {
      headers: {
        Authorization: `Bearer ${accessToken}`,
        Accept: "application/json",
      },
    });

    if (!response.ok) {
      throw new Error(
        `Failed to fetch list items. Status: ${response.status}, Error: ${response.statusText}`
      );
    }

    const data = await response.json();

    // Locate the correct item by Application ID
    const matchingItem = data.value.find(
      (item) => item.fields && item.fields.Title === applicationId
    );

    if (!matchingItem) {
      throw new Error(`No matching item found for Application ID: ${applicationId}`);
    }

    // Get the DocumentLibrary field
    const documentLibraryLink = matchingItem.fields.DocumentLibrary.Url;

    if (!documentLibraryLink) {
      throw new Error(`Document Library link not found for Application ID: ${applicationId}`);
    }

    return documentLibraryLink; // Return the link to the document library
  } catch (error) {
    console.error("Error fetching list item by Application ID:", error);
    throw error;
  }
}

async function uploadFileToDocumentLibrary(file) {
    try {
        // Retrieve user information from localStorage
        const userInfo = JSON.parse(localStorage.getItem("userInfo"));
        const applicationId = userInfo.appId;

        // Ensure user is authenticated
        await ensureAuthenticated();

        // Step 1: Acquire Token
        const accessToken = await acquireTokenWithInteractionCheck();

        // Step 2: Fetch the Document Library URL using the Application ID
        const documentLibraryUrl = await getListItemByApplicationId(accessToken, applicationId);

        // Step 3: Fetch the SharePoint Site and Drive IDs
        const driveId = `b!1lIwvqtQjUeQ4NoLYBC-xHhW9slCU4xFjgoMJajS_JSZlcK5T3QaSK4ZRUcd-IMR`;
        
        // Step 4: Derive Folder Path and Create if Needed
        const folderPath = documentLibraryUrl.split("/ERASEMI/Applications/")[1];

        // Step 5: Upload the File using the uploadFile function
        const uploadedFile = await uploadFile(driveId, folderPath, file, accessToken);

        console.log("File uploaded successfully:", uploadedFile);
        alert("File uploaded to SharePoint successfully!");
    } catch (error) {
        console.error("Error during file upload:", error);
        alert("Error uploading file. Please try again.");
    }
}

async function fetchApplicationIdsOnStart() {
  try {
    // Ensure user is authenticated
    await ensureAuthenticated();

    // Acquire access token
    const accessToken = await acquireTokenWithInteractionCheck();

    // Fetch the Application IDs from SharePoint
    const response = await fetch(
      "https://graph.microsoft.com/v1.0/sites/enervaca.sharepoint.com:/sites/ERASEMI:/lists/FRA List/items?$expand=fields",
      {
        headers: {
          Authorization: `Bearer ${accessToken}`,
          Accept: "application/json",
        },
      }
    );

    if (!response.ok) {
      throw new Error(
        `Failed to fetch list items. Status: ${response.status}, Error: ${response.statusText}`
      );
    }

    const data = await response.json();

    // Store Application IDs
    applicationIds = data.value.map((item) => item.fields.Title); // Assuming the Application ID is in the "Title" field
    console.log("Fetched Application IDs:", applicationIds);
  } catch (error) {
    console.error("Error fetching Application IDs on start:", error);
    alert("Unable to fetch Application IDs. Please refresh the page.");
  }
}

// Call this function when the application starts
document.addEventListener("DOMContentLoaded", fetchApplicationIdsOnStart);


    // This function wraps the upload process.
    async function uploadReport() {
      // First, generate the report as a Word document blob using the same HTML as downloadReport.
      var header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
                   "xmlns:w='urn:schemas-microsoft-com:office:word' " +
                   "xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>EMIS Report</title>" +
                   "<style>" +
                   "body { font-family: 'Roboto', sans-serif; margin: 40px; line-height: 1.6; } " +
                   "h2, h3, h4 { margin-bottom: 15px; } " +
                   "p { margin: 15px 0; } " +
                   "ul { margin: 15px 0 15px 40px; } " +
                   "li { margin-bottom: 10px; }" +
                   "</style></head><body>";
      var footer = "</body></html>";
      var reportText = document.getElementById('reportOutput').innerHTML;
      var sourceHTML = header + reportText + footer;
      var blob = new Blob([sourceHTML], { type: "application/msword" });
      // Create a File object with a timestamped name
      var ts = new Date().toISOString().replace(/[:]/g, "-");
      var file = new File([blob], `EMIS_Report_${ts}.doc`, { type: "application/msword" });
      
      try {
        await ensureAuthenticated();
        await uploadFileToDocumentLibrary(file);
        alert("Report successfully uploaded to SharePoint!");
      } catch (error) {
        console.error("Error during report upload:", error);
        alert("Error uploading report. Please try again.");
      }
    }
    
    /***** User Info & Attendee Functions *****/
    let attendeeList = [];
    function renderAttendees() {
      const attendeeListElement = document.getElementById("attendee-list");
      attendeeListElement.innerHTML = "";
      attendeeList.forEach((name, index) => {
        const li = document.createElement("li");
        li.textContent = name;
        const btn = document.createElement("button");
        btn.textContent = "Remove";
        btn.onclick = () => {
          attendeeList.splice(index, 1);
          renderAttendees();
        };
        li.appendChild(btn);
        attendeeListElement.appendChild(li);
      });
    }
    document.getElementById("add-attendee-btn").addEventListener("click", () => {
      const input = document.getElementById("attendee-names");
      const name = input.value.trim();
      if (name) {
        attendeeList.push(name);
        input.value = "";
        renderAttendees();
      } else {
        alert("Please enter a name!");
      }
    });
    
    /***** Start Assessment: Save User Info and Show Survey *****/
    document.getElementById("start-assessment").addEventListener("click", () => {
      const applicationId = document.getElementById("application-name").value.trim();
      if (!applicationId) {
        alert("Please enter an Application ID.");
        return;
      }
      if (applicationIds.includes(applicationId)) {
      // Save user info to localStorage
      const userdata = {
        appId: applicationId,
        orgName: document.getElementById("organization-name").value,
        orgType: document.getElementById("organization-type").value,
        siteAddress: document.getElementById("site-address").value,
        attendeeNames: attendeeList
      };
      localStorage.setItem("userInfo", JSON.stringify(userdata));
      // Hide user info page and show survey page
      showPage("page1");
    }else{
        alert("Invalid Application ID. Please check and try again.");
    }
    });
  </script>
</body>
</html>
